
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://pcsx-redux.consoledev.net/lua/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.1">
    
    
      
        <title>Lua API - PCSX-Redux</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e8d9bf0c.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lua-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PCSX-Redux" class="md-header__button md-logo" aria-label="PCSX-Redux" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PCSX-Redux
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lua API
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/grumpycoders/pcsx-redux/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PCSX-Redux" class="md-nav__button md-logo" aria-label="PCSX-Redux" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    PCSX-Redux
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/grumpycoders/pcsx-redux/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../menus/" class="md-nav__link">
        PCSX-Redux menus
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../compiling/" class="md-nav__link">
        Compiling PCSX-Redux
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../cli_flags/" class="md-nav__link">
        Command Line Flags
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../gdb-server/" class="md-nav__link">
        GDB server
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../mips_api/" class="md-nav__link">
        Mips API
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../CPU_trace_dump/" class="md-nav__link">
        Dumping a CPU trace to a file
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../web_server/" class="md-nav__link">
        Web server
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Lua API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Lua API
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lua-engine" class="md-nav__link">
    Lua engine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lua-console" class="md-nav__link">
    Lua console
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lua-editor" class="md-nav__link">
    Lua editor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    API
  </a>
  
    <nav class="md-nav" aria-label="API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-lua" class="md-nav__link">
    Basic Lua
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dear-imgui" class="md-nav__link">
    Dear ImGui
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opengl" class="md-nav__link">
    OpenGL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luv" class="md-nav__link">
    Luv
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zlib" class="md-nav__link">
    Zlib
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ffi-reflect" class="md-nav__link">
    FFI-Reflect
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pprint" class="md-nav__link">
    PPrint
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pcsx-redux" class="md-nav__link">
    PCSX-Redux
  </a>
  
    <nav class="md-nav" aria-label="PCSX-Redux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#settings" class="md-nav__link">
    Settings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imgui-interaction" class="md-nav__link">
    ImGui interaction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events-engine-interaction-execution-contexts" class="md-nav__link">
    Events Engine interaction &amp; Execution Contexts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-api" class="md-nav__link">
    File API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iso-files" class="md-nav__link">
    Iso files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events" class="md-nav__link">
    Events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-and-registers" class="md-nav__link">
    Memory and registers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constants" class="md-nav__link">
    Constants
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pads" class="md-nav__link">
    Pads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-flow" class="md-nav__link">
    Execution flow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#messages" class="md-nav__link">
    Messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gui" class="md-nav__link">
    GUI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpu" class="md-nav__link">
    GPU
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#breakpoints" class="md-nav__link">
    Breakpoints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#case-studies" class="md-nav__link">
    Case studies
  </a>
  
    <nav class="md-nav" aria-label="Case studies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spyro-year-of-the-dragon" class="md-nav__link">
    Spyro: Year of the Dragon
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crash-bandicoot" class="md-nav__link">
    Crash Bandicoot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crash-bandicoot-using-conditional-breakpoints" class="md-nav__link">
    Crash Bandicoot - Using Conditional BreakPoints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../openbios/" class="md-nav__link">
        Openbios
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lua-engine" class="md-nav__link">
    Lua engine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lua-console" class="md-nav__link">
    Lua console
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lua-editor" class="md-nav__link">
    Lua editor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    API
  </a>
  
    <nav class="md-nav" aria-label="API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-lua" class="md-nav__link">
    Basic Lua
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dear-imgui" class="md-nav__link">
    Dear ImGui
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#opengl" class="md-nav__link">
    OpenGL
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luv" class="md-nav__link">
    Luv
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zlib" class="md-nav__link">
    Zlib
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ffi-reflect" class="md-nav__link">
    FFI-Reflect
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pprint" class="md-nav__link">
    PPrint
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pcsx-redux" class="md-nav__link">
    PCSX-Redux
  </a>
  
    <nav class="md-nav" aria-label="PCSX-Redux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#settings" class="md-nav__link">
    Settings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imgui-interaction" class="md-nav__link">
    ImGui interaction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events-engine-interaction-execution-contexts" class="md-nav__link">
    Events Engine interaction &amp; Execution Contexts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-api" class="md-nav__link">
    File API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#iso-files" class="md-nav__link">
    Iso files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events" class="md-nav__link">
    Events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-and-registers" class="md-nav__link">
    Memory and registers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constants" class="md-nav__link">
    Constants
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pads" class="md-nav__link">
    Pads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-flow" class="md-nav__link">
    Execution flow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#messages" class="md-nav__link">
    Messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gui" class="md-nav__link">
    GUI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gpu" class="md-nav__link">
    GPU
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#breakpoints" class="md-nav__link">
    Breakpoints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#case-studies" class="md-nav__link">
    Case studies
  </a>
  
    <nav class="md-nav" aria-label="Case studies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spyro-year-of-the-dragon" class="md-nav__link">
    Spyro: Year of the Dragon
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crash-bandicoot" class="md-nav__link">
    Crash Bandicoot
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crash-bandicoot-using-conditional-breakpoints" class="md-nav__link">
    Crash Bandicoot - Using Conditional BreakPoints
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/grumpycoders/pcsx-redux/edit/docs/docs/lua.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>



<h1 id="lua-api">Lua API</h1>
<p>PCSX-Redux features a Lua API that's available through either a direct Lua console, or a Lua editor, both available through the Debug menu. The Lua VM runs on the main thread, the same one as the UI and the emulated MIPS CPU. As a result, care must be taken to not stall for too long, or the UI will become unresponsive. Using coroutines to handle long-running tasks is recommended, yielding periodically to let the UI perform some work too. The UI is probably going to run at 60FPS or so, which gives a ballpark of 15ms per frame.</p>
<h2 id="lua-engine">Lua engine</h2>
<p>The Lua engine that's being used is LuaJIT 2.1.0-beta3 compiled in Lua 5.2 compatibility mode. The <a href="https://www.lua.org/manual/5.1/">Lua 5.1 user manual</a> and <a href="https://luajit.org/extensions.html">LuaJIT user manual</a> are recommended reads. In particular, the bindings heavily make use of LuaJIT's FFI capabilities, which allows for direct memory access within the emulator's process. This means there is little protection against dramatic crashes the LuaJIT FFI engine can cause into the emulator's process, and the user must pay extra attention while manipulating FFI objects. Despite that, the code tries as much as possible to sandbox what the Lua code does, and will prevent crashes on any recoverable exception, including OpenGL and ImGui exceptions.</p>
<h2 id="lua-console">Lua console</h2>
<p>All of the messages coming from Lua should display into the Lua console directly. The input text there is a single line execution, so the user can type one-liner Lua statements and get an immediate result.</p>
<h2 id="lua-editor">Lua editor</h2>
<p>The editor allows for more complex, multi-line statements to be written, such as complete functions. The editor will by default auto save its contents on the disc under the filename <code>pcsx.lua</code>, which can potentially be a problem if the last statement typed crashed the emulator, as it'll be reloaded on the next startup. It might become necessary to either edit the file externally, or simply delete it to recover from this state.</p>
<p>The auto-execution of the editor permits for rapid development loop, with immediate feedback of what's done.</p>
<p>For complex projects however, it is recommended to split your work into sub-modules, and use the <code>loadfile</code> function to load them in your main code. This implies working on your project using an external editor.</p>
<h2 id="api">API</h2>
<h3 id="basic-lua">Basic Lua</h3>
<p>The <a href="https://luajit.org/extensions.html">LuaJIT extensions</a> are fully loaded, and can be used globally. Most of the <a href="https://www.lua.org/manual/5.1/manual.html#5">standard Lua libraries</a> are loaded, and are usable. The <code>require</code> function exists, but isn't recommended as the loading of external DLLs might be difficult to properly accomplish. Loading pure Lua files is fine. The <code>ffi</code> table is loaded globally, there is no need to <code>require</code> it, but it'll work nonetheless. As a side-effect of Luv, <a href="https://github.com/keplerproject/lua-compat-5.3">Lua-compat-5.3</a> is loaded.</p>
<h3 id="dear-imgui">Dear ImGui</h3>
<p>A good portion of <a href="https://github.com/ocornut/imgui">ImGui</a> is bound to the Lua environment, and it's possible for the Lua code to emit arbitrary widgets through ImGui. It is advised to consult the <a href="https://pthom.github.io/imgui_manual_online/manual/imgui_manual.html">user manual</a> of ImGui in order to properly understand how to make use of it. The list of current bindings can be found <a href="https://github.com/grumpycoders/pcsx-redux/blob/main/third_party/imgui_lua_bindings/imgui_iterator.inl">within the source code</a>. Some usage examples will be provided within the case studies.</p>
<h3 id="opengl">OpenGL</h3>
<p>OpenGL is bound directly to the Lua API through FFI bindings, loosely inspired and adapted from <a href="https://github.com/malkia/luajit-opencl">LuaJIT-OpenCL</a>. Some usage examples can be seen in the CRT-Lottes shader configuration page.</p>
<h3 id="luv">Luv</h3>
<p>For network access and interaction, PCSX-Redux uses libuv internally, and this is exposed to the Lua API through <a href="https://github.com/luvit/luv">Luv</a></p>
<h3 id="zlib">Zlib</h3>
<p>The Zlib C-API is exposed through <a href="https://github.com/luapower/zlib">FFI bindings</a>.</p>
<h3 id="ffi-reflect">FFI-Reflect</h3>
<p>The <a href="https://github.com/corsix/ffi-reflect">FFI-Reflect</a> library is loaded globally as the <code>reflect</code> symbol. It's able to generate reflection objects for the LuaJIT FFI module.</p>
<h3 id="pprint">PPrint</h3>
<p>The <a href="https://github.com/jagt/pprint.lua">PPrint</a> library is loaded globally as the <code>pprint</code> symbol. It's a more powerful <code>print</code> function than the one provided by Lua, and can be used to print tables in a more readable way.</p>
<h3 id="pcsx-redux">PCSX-Redux</h3>
<h4 id="settings">Settings</h4>
<p>All of the settings are exposed to Lua via the <code>PCSX.settings</code> table. It contains pseudo-tables that are reflections of the internal objects, and can be used to read and write the settings. The exact list of settings can vary quickly over time, so making a full list here would be fruitless. It is possible however to traverse the settings using <code>pprint</code> for example. The semantic of the settings is the same as from within the GUI, with the same caveats. For example, disabling the dynamic recompiler requires a reboot of the emulator.</p>
<h4 id="imgui-interaction">ImGui interaction</h4>
<p>PCSX-Redux will periodically try to call the Lua function <code>DrawImguiFrame</code> to allow the Lua code to draw some widgets on screen. The function will be called exactly once per actual UI frame draw, which, when the emulator is running, will correspond to the emulated GPU's vsync. If the function throws an exception however, it will be disabled until recompiled with new code.</p>
<h4 id="events-engine-interaction-execution-contexts">Events Engine interaction &amp; Execution Contexts</h4>
<p>LuaJIT C callbacks aren't called from a safe execution context that can allow for coroutine resuming, and luv's execution context doesn't have any error handling.</p>
<p>It is possible to defer executing code to the main loop of PCSX, which can (a) resume coroutines and (b) execute code in a safe context. The function <code>PCSX.nextTick(func)</code> will execute the given function in the next main loop iteration. Here's some examples of how to use it:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>    <span class="kd">local</span> <span class="n">captures</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">captures</span><span class="p">.</span><span class="n">current</span> <span class="o">=</span> <span class="nb">coroutine.running</span><span class="p">()</span>
    <span class="n">captures</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
        <span class="n">PCSX</span><span class="p">.</span><span class="n">nextTick</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
            <span class="n">captures</span><span class="p">.</span><span class="n">callback</span><span class="p">:</span><span class="n">free</span><span class="p">()</span>
            <span class="nb">coroutine.resume</span><span class="p">(</span><span class="n">captures</span><span class="p">.</span><span class="n">current</span><span class="p">)</span>
        <span class="kr">end</span><span class="p">)</span>
    <span class="kr">end</span>
    <span class="n">captures</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;void (*)()&#39;</span><span class="p">,</span> <span class="n">captures</span><span class="p">.</span><span class="n">callback</span><span class="p">)</span>
    <span class="c1">-- use the C callback somewhere...</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kr">function</span> <span class="nf">createClient</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
  <span class="n">client</span> <span class="o">=</span> <span class="n">luv</span><span class="p">.</span><span class="n">new_tcp</span><span class="p">()</span>

  <span class="n">luv</span><span class="p">.</span><span class="n">tcp_connect</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="kr">function</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="n">PCSX</span><span class="p">.</span><span class="n">nextTick</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
      <span class="nb">assert</span><span class="p">(</span><span class="ow">not</span> <span class="n">err</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

      <span class="n">luv</span><span class="p">.</span><span class="n">read_start</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="kr">function</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span>
        <span class="n">PCSX</span><span class="p">.</span><span class="n">nextTick</span><span class="p">(</span><span class="kr">function</span><span class="p">()</span>
          <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;received at client&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">err</span><span class="o">=</span><span class="n">err</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">})</span>
          <span class="nb">assert</span><span class="p">(</span><span class="ow">not</span> <span class="n">err</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
          <span class="kr">if</span> <span class="n">chunk</span> <span class="kr">then</span>
            <span class="c1">-- do something with the client</span>
          <span class="kr">else</span>
            <span class="n">luv</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
          <span class="kr">end</span>
        <span class="kr">end</span><span class="p">)</span>
      <span class="p">)</span>

      <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;writing from client&quot;</span><span class="p">)</span>
      <span class="n">luv</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
      <span class="n">luv</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s2">&quot;World&quot;</span><span class="p">)</span>

    <span class="kr">end</span>
  <span class="kr">end</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">client</span>
<span class="kr">end</span>
</code></pre></div>
</td></tr></table>
<p>Of course, this can also delay processing significantly, as the main loop is usually bound to the speed of the UI, which can mean up to 13ms of delay.</p>
<h4 id="file-api">File API</h4>
<p>While the normal Lua io API is loaded, there's a more powerful API that's more tightly integrated with the rest of the PCSX-Redux File handling code. It's an abstraction class that allows seamless manipulation of various objects using a common API.</p>
<p>The File objects have different properties depending on how they are created and their intention. But generally speaking, the following rules apply:</p>
<ul>
<li>Files are reference counted. They will be deleted when the reference count reaches zero. The Lua garbage collector will only decrease the reference count.</li>
<li>Whenever possible, writes are deferred to an asynchronous thread, making writes return basically instantly. This speed up comes at the trade off of data integrity, which means writes aren't guaranteed to be flushed to the disk yet when the function returns. Data will always have integrity internally within PCSX-Redux however.</li>
<li>Some File objects can be cached. When caching, reads and writes will be done transparently, and the cache will be used instead of the actual file. This will make reads return basically instantly too.</li>
<li>The Read and Write APIs can haul LuaBuffer objects. These are Lua objects that can be used to read and write data to the file. You can construct one using the <code>Support.NewLuaBuffer(size)</code> function. They can be cast to strings, and can be used as a table for reading and writing bytes off of it, in a 0-based fashion. The length operator will return the size of the buffer. The methods <code>:maxsize()</code> and <code>:resize(size)</code> are available.</li>
<li>If the file isn't closed when the file object is destroyed, it'll be closed then, but letting the garbage collector do the closing is not recommended. This is because the garbage collector will only run when the memory pressure is high enough, and the file handle will be held for a long time.</li>
<li>When using streamed functions, unlike POSIX files handles, there's two distinct seeking pointers: one for reading and one for writing.</li>
</ul>
<p>All File objects have the following API attached to them as methods:</p>
<p>Closes and frees any associated resources. Better to call this manually than letting the garbage collector do it:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
</td></tr></table></p>
<p>Reads from the File object and advances the read pointer accordingly. The return value depends on the variant used.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>      <span class="c1">-- returns a LuaBuffer</span>
<span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="c1">-- returns the number of bytes read, ptr has to be a cdata of pointer type</span>
<span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>    <span class="c1">-- returns the number of bytes read, and adjusts the buffer&#39;s size</span>
</code></pre></div>
</td></tr></table></p>
<p>Reads from the File object at the specified position. No pointers are modified. The return value depends on the variant used, just like the non-At variants above.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">readAt</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">:</span><span class="n">readAt</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">:</span><span class="n">readAt</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
</code></pre></div>
</td></tr></table></p>
<p>Writes to the File object. The non-At variants will advances the write pointer accordingly. The At variants will not modify the write pointer, and simply write at the requested location. Returns the number of bytes written. The <code>string</code> variants will in fact take any object that can be transformed to a string using <code>tostring()</code>.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
<span class="p">:</span><span class="n">writeAt</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">:</span><span class="n">writeAt</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">:</span><span class="n">writeAt</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
</code></pre></div>
</td></tr></table></p>
<p>Some APIs may return a <code>Slice</code> object, which is an opaque buffer coming from C++. It's possible to write a slice to a file in a zero-copy manner:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">writeMoveSlice</span><span class="p">(</span><span class="n">slice</span><span class="p">)</span>
<span class="p">:</span><span class="n">writeAtMoveSlice</span><span class="p">(</span><span class="n">slice</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>After which, the slice will be consumed and not reusable. The object is convertible to a string, and also has two members: <code>data</code>, which is a <code>const void*</code>, and <code>size</code>. Once consumed, the size of a slice will go down to zero.</p>
<p>The following methods manipulate the read and write pointers. All of them return their corresponding pointer. The <code>wheel</code> argument can be of the values <code>'SEEK_SET'</code>, <code>'SEEK_CUR'</code>, and <code>'SEEK_END'</code>, and will default to <code>'SEEK_SET'</code>.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">rSeek</span><span class="p">(</span><span class="n">pos</span><span class="p">[,</span> <span class="n">wheel</span><span class="p">])</span>
<span class="p">:</span><span class="n">rTell</span><span class="p">()</span>
<span class="p">:</span><span class="n">wSeek</span><span class="p">(</span><span class="n">pos</span><span class="p">[,</span> <span class="n">wheel</span><span class="p">])</span>
<span class="p">:</span><span class="n">wTell</span><span class="p">()</span>
</code></pre></div>
</td></tr></table></p>
<p>These will query the corresponding File object.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">size</span><span class="p">()</span>      <span class="c1">-- Returns the size in bytes, if possible. If the file is not seekable, will throw an error.</span>
<span class="p">:</span><span class="n">seekable</span><span class="p">()</span>  <span class="c1">-- Returns true if the file is seekable.</span>
<span class="p">:</span><span class="n">writable</span><span class="p">()</span>  <span class="c1">-- Returns true if the file is writable.</span>
<span class="p">:</span><span class="n">eof</span><span class="p">()</span>       <span class="c1">-- Returns true if the read pointer is at the end of file.</span>
<span class="p">:</span><span class="n">failed</span><span class="p">()</span>    <span class="c1">-- Returns true if the file failed in some ways. The File object is defunct if this is true.</span>
<span class="p">:</span><span class="n">cacheable</span><span class="p">()</span> <span class="c1">-- Returns true if the file is cacheable.</span>
<span class="p">:</span><span class="n">caching</span><span class="p">()</span>   <span class="c1">-- Returns true if caching is in progress or completed.</span>
<span class="p">:</span><span class="n">cacheProgress</span><span class="p">()</span> <span class="c1">-- Returns a value between 0 and 1 indicating the progress of the caching operation.</span>
</code></pre></div>
</td></tr></table></p>
<p>If applicable, this will start caching the corresponding file in memory.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">startCaching</span><span class="p">()</span>
</code></pre></div>
</td></tr></table></p>
<p>Same as above, but will suspend the current coroutine until the caching is done. Cannot be used with the main thread.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">startCachingAndWait</span><span class="p">()</span>
</code></pre></div>
</td></tr></table></p>
<p>Duplicates the File object. This will re-open the file, and possibly duplicate all ressources associated with it.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">dup</span><span class="p">()</span>
</code></pre></div>
</td></tr></table></p>
<p>Creates a read-only view of the file starting at the specified position, spanning the specified length. The view will be a new File object, and will be a view of the same underlying file. The default values of start and length are 0 and -1 respectively, which will effectively create a view of the entire file. The view may have less features than the underlying file, but will always be seekable, and keep its seeking position independent of the underlying file. The view will hold a reference to the underlying file.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">subFile</span><span class="p">([</span><span class="n">start</span><span class="p">[,</span> <span class="n">length</span><span class="p">]])</span>
</code></pre></div>
</td></tr></table></p>
<p>In addition to the above methods, the File API has these helpers, that'll read or write binary values off their corresponding stream position for the non-At variants, or at the indicated position for the At variants. All the values will be read or store in Little Endian, regardless of the host's endianness.
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">readU8</span><span class="p">(),</span> <span class="p">:</span><span class="n">readU16</span><span class="p">(),</span> <span class="p">:</span><span class="n">readU32</span><span class="p">(),</span> <span class="p">:</span><span class="n">readU64</span><span class="p">(),</span>
<span class="p">:</span><span class="n">readI8</span><span class="p">(),</span> <span class="p">:</span><span class="n">readI16</span><span class="p">(),</span> <span class="p">:</span><span class="n">readI32</span><span class="p">(),</span> <span class="p">:</span><span class="n">readI64</span><span class="p">(),</span>
<span class="p">:</span><span class="n">readU8At</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">readU16At</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">readU32At</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">readU64At</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span>
<span class="p">:</span><span class="n">readI8At</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">readI16At</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">readI32At</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">readI64At</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span>
<span class="p">:</span><span class="n">writeU8</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="p">:</span><span class="n">writeU16</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="p">:</span><span class="n">writeU32</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="p">:</span><span class="n">writeU64</span><span class="p">(</span><span class="n">val</span><span class="p">),</span>
<span class="p">:</span><span class="n">writeI8</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="p">:</span><span class="n">writeI16</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="p">:</span><span class="n">writeI32</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="p">:</span><span class="n">writeI64</span><span class="p">(</span><span class="n">val</span><span class="p">),</span>
<span class="p">:</span><span class="n">writeU8At</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">writeU16At</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">writeU32At</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">writeU64At</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span>
<span class="p">:</span><span class="n">writeI8At</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">writeI16At</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">writeI32At</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="p">:</span><span class="n">writeI64At</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span>
</code></pre></div>
</td></tr></table></p>
<p>The Lua VM can create File objects in different ways:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">Support</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">[,</span> <span class="nb">type</span><span class="p">])</span>
<span class="n">Support</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">buffer</span><span class="p">()</span>
<span class="n">Support</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">[,</span> <span class="nb">type</span><span class="p">])</span>
<span class="n">Support</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">uvFifo</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</code></pre></div>
</td></tr></table></p>
<p>The <code>open</code> function will function on filesystem and network URLs, while the <code>buffer</code> function will generate a memory-only File object that's fully readable, writable, and seekable. The <code>type</code> argument of the <code>open</code> function will determine what happens exactly. It's a string that can have the following values:</p>
<ul>
<li><code>READ</code>: Opens the file for reading only. Will fail if the file does not exist. This is the default type.</li>
<li><code>TRUNCATE</code>: Opens the file for reading and writing. If the file does not exist, it will be created. If it does exist, it will be truncated to 0 size.</li>
<li><code>CREATE</code>: Opens the file for reading and writing. If the file does not exist, it will be created. If it does exist, it will be left untouched.</li>
<li><code>READWRITE</code>: Opens the file for reading and writing. Will fail if the file does not exist.</li>
<li><code>DOWNLOAD_URL</code>: Opens the file for reading only. Will immediately start downloading the file from the network. The <a href="http://curl.se/libcurl">curl</a> is the backend for this feature, and its <a href="https://everything.curl.dev/cmdline/urls">url schemes</a> are supported. The progress of the download can be monitored with the <code>:cacheProgress()</code> method.</li>
<li><code>DOWNLOAD_URL_AND_WAIT</code>: As above, but suspends the current coroutine until the download is done. Cannot be used with the main thread.</li>
<li><code>ACQUIRE</code>: Only valid for <code>buffer</code>. See below.</li>
</ul>
<p>When calling <code>buffer()</code> with no argument, this will create an empty read-write buffer. When calling it with a pointer and a size, this will have the following behavior, depending on type:
- <code>READWRITE</code> (or no type): The memory passed as an argument will be copied first.
- <code>READ</code>: The memory passed as an argument will be referenced, and the lifespan of said memory needs to outlast the File object. The File object will be read-only.
- <code>ACQUIRE</code>: It will acquire the pointer passed as an argument, and free it later using <code>free()</code>, meaning it needed to be allocated using <code>malloc()</code> in the first place.</p>
<p>The <code>uvFifo</code> function will create a File object that will read from and write to the specified TCP address and port after connecting to it. The <code>:failed()</code> method will return true in case of a connection failure. The address is a string, and must be a strict IP address. The port is a number. As the name suggests, this object is a FIFO, meaning that incoming bytes will be consumed by any read operation. The <code>:size()</code> method will return the number of bytes in the FIFO. Writes will be immediately sent over. There are no reception guarantees, as the other side might have disconnected at any point. The <code>:eof()</code> method will return true when the opposite end of the stream has been disconnected and there's no more bytes in the FIFO.</p>
<h4 id="iso-files">Iso files</h4>
<p>There is some limited API for working with ISO files.</p>
<ul>
<li><code>PCSX.getCurrentIso()</code> will return an <code>Iso</code> object representing the currently loaded ISO file by the emulator. The following methods are available:</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">failed</span><span class="p">()</span>       <span class="c1">-- Returns true if the Iso file failed in some ways. The Iso object is defunct if this is true.</span>
<span class="p">:</span><span class="n">createReader</span><span class="p">()</span> <span class="c1">-- Returns an ISOReader object off the Iso file.</span>
<span class="p">:</span><span class="n">open</span><span class="p">(</span><span class="n">lba</span><span class="p">[,</span> <span class="n">size</span><span class="p">[,</span> <span class="n">mode</span><span class="p">]])</span> <span class="c1">-- Returns a File object off the specified span of sectors.</span>
</code></pre></div>
</td></tr></table>
<p>The <code>:open</code> method has some magic built-in. The size argument is optional, and if missing, the code will attempt to guess the size of the underlying file within the Iso. This can only work on MODE2 FORM1 or FORM2 sectors, and will result in a failed File object otherwise. The mode argument is optional, and can be one of the following:</p>
<ul>
<li><code>'GUESS'</code>: will attempt to guess the mode of the file. This is the default.</li>
<li><code>'RAW'</code>: the returned File object will read 2352 bytes per sector.</li>
<li><code>'M1'</code>: the returned File object will read 2048 bytes per sector.</li>
<li><code>'M2_RAW'</code>: the returned File object will read 2336 bytes per sector. This can't be guessed. This is useful for extracting STR files that require the subheaders to be present.</li>
<li><code>'M2_FORM1'</code>: the returned File object will read 2048 bytes per sector.</li>
<li><code>'M2_FORM2'</code>: the returned File object will read 2324 bytes per sector.</li>
</ul>
<p>The resulting File object will cache a single full sector in memory, meaning that small sequential reads won't read the same sector over and off from the disk.</p>
<p>The ISOReader object has the following methods:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">:</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="c1">-- Returns a File object off the specified file within the ISO.</span>
</code></pre></div>
</td></tr></table>
<h4 id="events">Events</h4>
<p>The Lua code can listen for events broadcasted from within the emulator. The following function is available to register a callback to be called when certain events happen:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">PCSX</span><span class="p">.</span><span class="n">Events</span><span class="p">.</span><span class="n">createEventListener</span><span class="p">(</span><span class="n">eventName</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>The callback function will be called from an unsecured environment, and it is advised to delegate anything complex or risky enough to <code>PCSX.nextTick</code>.</p>
<p>The <code>eventName</code> argument is a string that can have the following values:</p>
<ul>
<li><code>Quitting</code>: The emulator is about to quit. The callback will be called with no arguments. This is where you'd need to close libuv objects held by Lua through luv in order to allow the emulator to quit gracefully. Otherwise you may soft lock the application where it'll wait for libuv objects to close.</li>
<li><code>IsoMounted</code>: A new ISO file has been mounted into the virtual CDRom drive. The callback will be called with no arguments.</li>
<li><code>GPU::Vsync</code>: The emulated GPU has just completed a vertical blanking interval. The callback will be called with no arguments.</li>
<li><code>ExecutionFlow::ShellReached</code>: The emulation execution has reached the beginning of the BIOS' shell. The callback will be called with no arguments. This is the moment where the kernel is properly set up and ready to execute any arbitrary binary. The emulator may use this event to side load binaries, or signal gdb that the kernel is ready.</li>
<li><code>ExecutionFlow::Run</code>: The emulator resumed execution. The callback will be called with no arguments. This event will fire when calling <code>PCSX.resumeEmulator()</code>, when the user presses Start, or other potential interactions.</li>
<li><code>ExecutionFlow::Pause</code>: The emulator paused execution. The callback will be called with a table that contains a boolean named <code>exception</code>, indicating if the pause is the result of an execution exception within the emulated CPU. This event will fire on breakpoints too, so if breakpoints have Lua callbacks attached on them, they will be executed too.</li>
<li><code>ExecutionFlow::Reset</code>: The emulator is resetting the emulated machine. The callback will be called with a table that contains a boolean named <code>hard</code>, indicating if the reset is a hard reset or a soft reset. This event will fire when calling <code>PCSX.resetEmulator()</code>, when the user presses Reset, or other potential interactions.</li>
<li><code>GUI::JumpToPC</code>: The UI is being asked to move the assembly view cursor to the specified address. The callback will be called with a table that contains a number named <code>pc</code>, indicating the address to jump to.</li>
<li><code>GUI::JumpToMemory</code>: The UI is being asked to move the memory view cursor to the specified address. The callback will be called with a table that contains a number named <code>address</code>, indicating the address to jump to, and <code>size</code>, indicating the number of bytes to highlight.</li>
<li><code>Keyboard</code>: The emulator is dispatching keyboard events. The callback will be called with a table containing four numbers: <code>key</code>, <code>scancode</code>, <code>action</code>, and <code>mods</code>. They are the same values as the glfw callback set by <code>glfwSetKeyCallback</code>.</li>
</ul>
<h4 id="memory-and-registers">Memory and registers</h4>
<p>The Lua code can access the emulated memory and registers directly through some FFI bindings:</p>
<ul>
<li><code>PCSX.getMemPtr()</code> will return a <code>cdata[uint8_t*]</code> representing up to 8MB of emulated memory. This can be written to, but careful about the emulated i-cache in case code is being written to.</li>
<li><code>PCSX.getRomPtr()</code> will return a <code>cdata[uint8_t*]</code> representing up to 512kB of the BIOS memory space. This can be written to.</li>
<li><code>PCSX.getScratchPtr()</code> will return a <code>cdata[uint8_t*]</code> representing up to 1kB for the scratchpad memory space.</li>
<li><code>PCSX.getRegisters()</code> will return a structured cdata representing all the registers present in the CPU:</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">r0</span><span class="p">,</span><span class="w"> </span><span class="n">at</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">t0</span><span class="p">,</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">,</span><span class="w"> </span><span class="n">t3</span><span class="p">,</span><span class="w"> </span><span class="n">t4</span><span class="p">,</span><span class="w"> </span><span class="n">t5</span><span class="p">,</span><span class="w"> </span><span class="n">t6</span><span class="p">,</span><span class="w"> </span><span class="n">t7</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">,</span><span class="w"> </span><span class="n">s2</span><span class="p">,</span><span class="w"> </span><span class="n">s3</span><span class="p">,</span><span class="w"> </span><span class="n">s4</span><span class="p">,</span><span class="w"> </span><span class="n">s5</span><span class="p">,</span><span class="w"> </span><span class="n">s6</span><span class="p">,</span><span class="w"> </span><span class="n">s7</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">t8</span><span class="p">,</span><span class="w"> </span><span class="n">t9</span><span class="p">,</span><span class="w"> </span><span class="n">k0</span><span class="p">,</span><span class="w"> </span><span class="n">k1</span><span class="p">,</span><span class="w"> </span><span class="n">gp</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">s8</span><span class="p">,</span><span class="w"> </span><span class="n">ra</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">lo</span><span class="p">,</span><span class="w"> </span><span class="n">hi</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="mi">34</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">psxGPRRegs</span><span class="p">;</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">psxCP0Regs</span><span class="p">;</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">psxCP2Data</span><span class="p">;</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">psxCP2Ctrl</span><span class="p">;</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">psxGPRRegs</span><span class="w"> </span><span class="n">GPR</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">psxCP0Regs</span><span class="w"> </span><span class="n">CP0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">psxCP2Data</span><span class="w"> </span><span class="n">CP2D</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">psxCP2Ctrl</span><span class="w"> </span><span class="n">CP2C</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">pc</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">psxRegisters</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
</td></tr></table>
<h4 id="constants">Constants</h4>
<p>The table <code>PCSX.CONSTS</code> contains numerical constants used throughout the rest of the API. Keeping an up to date list here is too exhausting, and it's simpler to print them using <code>pprint(PCSX.CONSTS)</code>.</p>
<h4 id="pads">Pads</h4>
<p>You can access the pads API through <code>PCSX.SIO1.slots[s].pads[p]</code> where <code>s</code> is the slot number and <code>p</code> is the pad number, both indexed from 1, Lua-style. So <code>PCSX.SIO1.slots[1].pads[1]</code> accesses the first pad, and <code>PCSX.SIO1.slots[2].pads[1]</code> accesses the second pad.</p>
<p>Each Pad table has the following functions:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">getButton</span><span class="p">(</span><span class="n">button</span><span class="p">)</span>     <span class="c1">-- Returns true if the specified button is pressed.</span>
<span class="n">setOverride</span><span class="p">(</span><span class="n">button</span><span class="p">)</span>   <span class="c1">-- Overrides the specified button.</span>
<span class="n">clearOverride</span><span class="p">(</span><span class="n">button</span><span class="p">)</span> <span class="c1">-- Clears the override for the specified button.</span>
</code></pre></div>
</td></tr></table>
<p>The button constants can be found in <code>PCSX.CONSTS.PAD.BUTTON</code>.</p>
<p>You can for instance press the button Down on the first pad using the following code:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">PCSX</span><span class="p">.</span><span class="n">SIO1</span><span class="p">.</span><span class="n">slots</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pads</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">setOverride</span><span class="p">(</span><span class="n">PCSX</span><span class="p">.</span><span class="n">CONSTS</span><span class="p">.</span><span class="n">PAD</span><span class="p">.</span><span class="n">BUTTON</span><span class="p">.</span><span class="n">DOWN</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h4 id="execution-flow">Execution flow</h4>
<p>The Lua code has the following 4 API functions available to it in order to control the execution flow of the emulator:</p>
<ul>
<li><code>PCSX.pauseEmulator()</code></li>
<li><code>PCSX.resumeEmulator()</code></li>
<li><code>PCSX.softResetEmulator()</code></li>
<li><code>PCSX.hardResetEmulator()</code></li>
</ul>
<p>It's also possible to manipulate savestates using the following two functions:</p>
<ul>
<li><code>PCSX.createSaveState()    -- returns a slice representing the savestate</code></li>
<li><code>PCSX.loadSaveState(slice)</code></li>
</ul>
<h4 id="messages">Messages</h4>
<p>The globals <code>print</code> and <code>printError</code> are available, and will display logs in the Lua Console. You can also use <code>PCSX.log</code> to display a line in the general Log window. All three functions should behave the way you'd expect from a <code>print</code> function in Lua.</p>
<h4 id="gui">GUI</h4>
<p>You can move the cursor within the assembly window and the first memory view using the following two functions:</p>
<ul>
<li><code>PCSX.GUI.jumpToPC(pc)</code></li>
<li><code>PCSX.GUI.jumpToMemory(address[, width])</code></li>
</ul>
<h4 id="gpu">GPU</h4>
<p>You can take a screenshot of the current view of the emulated display using the following:
- <code>PCSX.GPU.takeScreenShot()</code></p>
<p>This will return a struct that has the following fields:
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">ScreenShot</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Slice</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">BPP_16</span><span class="p">,</span><span class="w"> </span><span class="n">BPP_24</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">bpp</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
</td></tr></table></p>
<p>The <code>Slice</code> will contain the raw bytes of the screenshot data. It's meant to be written out using the <code>:writeMoveSlice()</code> method. The <code>width</code> and <code>height</code> will be the width and height of the screenshot, in pixels. The <code>bpp</code> will be either <code>BPP_16</code> or <code>BPP_24</code>, depending on the color depth of the screenshot. The size of the <code>data</code> Slice will be <code>height * width</code> multiplied by the number of bytes per pixel, depending on the <code>bpp</code>.</p>
<h4 id="breakpoints">Breakpoints</h4>
<p>If the debugger is activated, and while using the interpreter, the Lua code can insert powerful breakpoints using the following API:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">PCSX</span><span class="p">.</span><span class="n">addBreakpoint</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">cause</span><span class="p">,</span> <span class="n">invoker</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p><strong>Important</strong>: the return value of this function will be an object that represents the breakpoint itself. If this object gets garbage collected, the corresponding breakpoint will be removed. Thus it is important to store it somewhere that won't get garbage collected right away.</p>
<p>The only mandatory argument is <code>address</code>, which will by default place an execution breakpoint at the corresponding address. The second argument <code>type</code> is an enum which can be represented by one of the 3 following strings: <code>'Exec'</code>, <code>'Read'</code>, <code>'Write'</code>, and will set the breakpoint type accordingly. The third argument <code>width</code> is the width of the breakpoint, which indicates how many bytes should intersect from the base address with operations done by the emulated CPU in order to actually trigger the breakpoint. The fourth argument <code>cause</code> is a string that will be displayed in the logs about why the breakpoint triggered. It will also be displayed in the Breakpoint Debug UI. And the fifth and final argument <code>invoker</code> is a Lua function that will be called whenever the breakpoint is triggered. By default, this will simply call <code>PCSX.pauseEmulator()</code>. If the invoker returns <code>false</code>, the breakpoint will be permanently removed, permitting temporary breakpoints for example. The signature of the invoker callback is:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kr">function</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">cause</span><span class="p">)</span>
    <span class="c1">-- body</span>
<span class="kr">end</span>
</code></pre></div>
</td></tr></table>
<p>The <code>address</code> parameter will contain the address that triggered the breakpoint. For <code>'Exec'</code> breakpoints, this is going to be the same as the current <code>pc</code>, but for <code>'Read'</code> and <code>'Write'</code>, it's going to be the actual accessed address. The <code>width</code> parameter will contain the width of the access that triggered the breakpoint, which can be different from what the breakpoint is monitoring. And the <code>cause</code> parameter will contain a string describing the reason for the breakpoint; the latter may or may not be the same as what was passed to the <code>addBreakpoint</code> function. Note that you don't need to strictly adhere to the signature, and have zero, one, two, or three arguments for your invoker callback. The return value of the invoker callback is also optional.</p>
<p>For example, these two examples are well formed and perfectly valid:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">bp1</span> <span class="o">=</span> <span class="n">PCSX</span><span class="p">.</span><span class="n">addBreakpoint</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">,</span> <span class="s1">&#39;Write&#39;</span><span class="p">,</span> <span class="mh">0x80000</span><span class="p">,</span> <span class="s1">&#39;Write tracing&#39;</span><span class="p">,</span> <span class="kr">function</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">cause</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">regs</span> <span class="o">=</span> <span class="n">PCSX</span><span class="p">.</span><span class="n">getRegisters</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">pc</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing at &#39;</span> <span class="o">..</span> <span class="n">address</span> <span class="o">..</span> <span class="s1">&#39; from &#39;</span> <span class="o">..</span> <span class="n">pc</span> <span class="o">..</span> <span class="s1">&#39; with width &#39;</span> <span class="o">..</span> <span class="n">width</span> <span class="o">..</span> <span class="s1">&#39; and cause &#39;</span> <span class="o">..</span> <span class="n">cause</span><span class="p">)</span>
<span class="kr">end</span><span class="p">)</span>

<span class="n">bp2</span> <span class="o">=</span> <span class="n">PCSX</span><span class="p">.</span><span class="n">addBreakpoint</span><span class="p">(</span><span class="mh">0x80030000</span><span class="p">,</span> <span class="s1">&#39;Exec&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Shell reached - pausing&#39;</span><span class="p">,</span> <span class="kr">function</span><span class="p">()</span>
    <span class="n">PCSX</span><span class="p">.</span><span class="n">pauseEmulator</span><span class="p">()</span>
    <span class="kr">return</span> <span class="kc">false</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>The returned object will have a few methods attached to it:</p>
<ul>
<li><code>:disable()</code></li>
<li><code>:enable()</code></li>
<li><code>:isEnabled()</code></li>
<li><code>:remove()</code></li>
</ul>
<p>A removed breakpoint will no longer have any effect whatsoever, and none of its methods will do anything. Remember it is possible for the user to still manually remove a breakpoint from the UI.</p>
<h2 id="case-studies">Case studies</h2>
<h3 id="spyro-year-of-the-dragon">Spyro: Year of the Dragon</h3>
<p>By looking up some of the <a href="https://www.cheatcc.com/psx/codes/spyroyotd.html">gameshark codes</a> for this game, we can determine the following memory addresses:</p>
<ul>
<li><code>0x8007582c</code> is the number of lives.</li>
<li><code>0x80078bbc</code> is the health of Spyro.</li>
<li><code>0x80075860</code> is the number of unspent jewels available to the player.</li>
<li><code>0x80075750</code> is the number of dragons Spyro released so far.</li>
</ul>
<p>With this, we can build a small UI to visualize and manipulate these values in real time:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">-- Declare a helper function with the following arguments:</span>
<span class="c1">--   mem: the ffi object representing the base pointer into the main RAM</span>
<span class="c1">--   address: the address of the uint32_t to monitor and mutate</span>
<span class="c1">--   name: the label to display in the UI</span>
<span class="c1">--   min, max: the minimum and maximum values of the slider</span>
<span class="c1">--</span>
<span class="c1">-- This function is local as to not pollute the global namespace.</span>
<span class="kd">local</span> <span class="kr">function</span> <span class="nf">doSliderInt</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">)</span>
  <span class="c1">-- Clamping the address to the actual memory space, essentially</span>
  <span class="c1">-- removing the upper bank address using a bitmask. The result</span>
  <span class="c1">-- will still be a normal 32-bits value.</span>
  <span class="n">address</span> <span class="o">=</span> <span class="n">bit</span><span class="p">.</span><span class="n">band</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x1fffff</span><span class="p">)</span>
  <span class="c1">-- Computing the FFI pointer to the actual uint32_t location.</span>
  <span class="c1">-- The result will be a new FFI pointer, directly into the emulator&#39;s</span>
  <span class="c1">-- memory space, hopefully within normal accessible bounds. The</span>
  <span class="c1">-- resulting type will be a cdata[uint8_t*].</span>
  <span class="kd">local</span> <span class="n">pointer</span> <span class="o">=</span> <span class="n">mem</span> <span class="o">+</span> <span class="n">address</span>
  <span class="c1">-- Casting this pointer to a proper uint32_t pointer.</span>
  <span class="n">pointer</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;uint32_t*&#39;</span><span class="p">,</span> <span class="n">pointer</span><span class="p">)</span>
  <span class="c1">-- Reading the value in memory</span>
  <span class="kd">local</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pointer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="c1">-- Drawing the ImGui slider</span>
  <span class="kd">local</span> <span class="n">changed</span>
  <span class="n">changed</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">imgui</span><span class="p">.</span><span class="n">SliderInt</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="s1">&#39;%d&#39;</span><span class="p">)</span>
  <span class="c1">-- The ImGui Lua binding will first return a boolean indicating</span>
  <span class="c1">-- if the user moved the slider. The second return value will be</span>
  <span class="c1">-- the new value of the slider if it changed. Therefore we can</span>
  <span class="c1">-- reassign the pointer accordingly.</span>
  <span class="kr">if</span> <span class="n">changed</span> <span class="kr">then</span> <span class="n">pointer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="kr">end</span>
<span class="kr">end</span>

<span class="c1">-- Utilizing the DrawImguiFrame periodic function to draw our UI.</span>
<span class="c1">-- We are declaring this function global so the emulator can</span>
<span class="c1">-- properly call it periodically.</span>
<span class="kr">function</span> <span class="nf">DrawImguiFrame</span><span class="p">()</span>
  <span class="c1">-- This is typical ImGui paradigm to display a window</span>
  <span class="kd">local</span> <span class="n">show</span> <span class="o">=</span> <span class="n">imgui</span><span class="p">.</span><span class="n">Begin</span><span class="p">(</span><span class="s1">&#39;Spyro internals&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="kr">if</span> <span class="ow">not</span> <span class="n">show</span> <span class="kr">then</span> <span class="n">imgui</span><span class="p">.</span><span class="n">End</span><span class="p">()</span> <span class="kr">return</span> <span class="kr">end</span>

  <span class="c1">-- Grabbing the pointer to the main RAM, to avoid calling</span>
  <span class="c1">-- the function for every pointer we want to change.</span>
  <span class="c1">-- Note: it&#39;s not a good idea to hold onto this value between</span>
  <span class="c1">-- calls to the Lua VM, as the memory can potentially move</span>
  <span class="c1">-- within the emulator&#39;s memory space.</span>
  <span class="kd">local</span> <span class="n">mem</span> <span class="o">=</span> <span class="n">PCSX</span><span class="p">.</span><span class="n">getMemPtr</span><span class="p">()</span>

  <span class="c1">-- Now calling our helper function for each of our pointer.</span>
  <span class="n">doSliderInt</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mh">0x8007582c</span><span class="p">,</span> <span class="s1">&#39;Lives&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
  <span class="n">doSliderInt</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mh">0x80078bbc</span><span class="p">,</span> <span class="s1">&#39;Health&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">doSliderInt</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mh">0x80075860</span><span class="p">,</span> <span class="s1">&#39;Jewels&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65000</span><span class="p">)</span>
  <span class="n">doSliderInt</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mh">0x80075750</span><span class="p">,</span> <span class="s1">&#39;Dragons&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>

  <span class="c1">-- Don&#39;t forget to close the ImGui window.</span>
  <span class="n">imgui</span><span class="p">.</span><span class="n">End</span><span class="p">()</span>
<span class="kr">end</span>
</code></pre></div>
</td></tr></table>
<p>You can see this code in action <a href="https://youtu.be/WeHXTLDy5rs">in this demo video</a>.</p>
<h3 id="crash-bandicoot">Crash Bandicoot</h3>
<p>Using exactly the same as above, we can repeat the same sort of cheats for Crash Bandicoot. Note that when the CPU is being emulated, the <code>DrawImguiFrame</code> function will be called at least when the emulation is issuing a vsync event. This means that cheat codes that regularly write to memory during vsync can be applied naturally.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kd">local</span> <span class="kr">function</span> <span class="nf">crash_Checkbox</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span>
  <span class="n">address</span> <span class="o">=</span> <span class="n">bit</span><span class="p">.</span><span class="n">band</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x1fffff</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">pointer</span> <span class="o">=</span> <span class="n">mem</span> <span class="o">+</span> <span class="n">address</span>
  <span class="n">pointer</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="s1">&#39;uint32_t*&#39;</span><span class="p">,</span> <span class="n">pointer</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">changed</span>
  <span class="kd">local</span> <span class="n">check</span>
  <span class="kd">local</span> <span class="n">tempvalue</span> <span class="o">=</span> <span class="n">pointer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="kr">if</span> <span class="n">tempvalue</span> <span class="o">==</span> <span class="n">original</span> <span class="kr">then</span> <span class="n">check</span> <span class="o">=</span> <span class="kc">false</span> <span class="kr">end</span>
  <span class="kr">if</span> <span class="n">tempvalue</span> <span class="o">==</span> <span class="n">value</span> <span class="kr">then</span> <span class="n">check</span> <span class="o">=</span> <span class="kc">true</span> <span class="kr">else</span> <span class="n">check</span> <span class="o">=</span> <span class="kc">false</span> <span class="kr">end</span>
  <span class="n">changed</span><span class="p">,</span> <span class="n">check</span> <span class="o">=</span> <span class="n">imgui</span><span class="p">.</span><span class="n">Checkbox</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span>
  <span class="kr">if</span> <span class="n">check</span> <span class="kr">then</span> <span class="n">pointer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="kr">else</span> <span class="n">pointer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">original</span> <span class="kr">end</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">DrawImguiFrame</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">show</span> <span class="o">=</span> <span class="n">imgui</span><span class="p">.</span><span class="n">Begin</span><span class="p">(</span><span class="s1">&#39;Crash Bandicoot Mods&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="kr">if</span> <span class="ow">not</span> <span class="n">show</span> <span class="kr">then</span> <span class="n">imgui</span><span class="p">.</span><span class="n">End</span><span class="p">()</span> <span class="kr">return</span> <span class="kr">end</span>
  <span class="kd">local</span> <span class="n">mem</span> <span class="o">=</span> <span class="n">PCSX</span><span class="p">.</span><span class="n">getMemPtr</span><span class="p">()</span>
  <span class="n">crash_Checkbox</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mh">0x80027f9a</span><span class="p">,</span> <span class="s1">&#39;Neon Crash&#39;</span><span class="p">,</span> <span class="mh">0x2400</span><span class="p">,</span> <span class="mh">0x100c00</span><span class="p">)</span>
  <span class="n">crash_Checkbox</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mh">0x8001ed5a</span><span class="p">,</span> <span class="s1">&#39;Unlimited Time Aku&#39;</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x3403</span><span class="p">)</span>
  <span class="n">crash_Checkbox</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mh">0x8001dd0c</span><span class="p">,</span> <span class="s1">&#39;Walk Mid-Air&#39;</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x8e0200c8</span><span class="p">)</span>
  <span class="n">crash_Checkbox</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mh">0x800618ec</span><span class="p">,</span> <span class="s1">&#39;99 Lives at Map&#39;</span><span class="p">,</span> <span class="mh">0x6300</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">)</span>
  <span class="n">crash_Checkbox</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mh">0x80061949</span><span class="p">,</span> <span class="s1">&#39;Unlock all Levels&#39;</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>
  <span class="n">crash_Checkbox</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mh">0x80019276</span><span class="p">,</span> <span class="s1">&#39;Disable Draw Level&#39;</span><span class="p">,</span> <span class="mh">0x20212400</span><span class="p">,</span> <span class="mh">0x20210c00</span><span class="p">)</span>
  <span class="n">imgui</span><span class="p">.</span><span class="n">End</span><span class="p">()</span>
<span class="kr">end</span>
</code></pre></div>
</td></tr></table>
<h3 id="crash-bandicoot-using-conditional-breakpoints">Crash Bandicoot - Using Conditional BreakPoints</h3>
<p>This example will showcase using the BreakPoints and Assembly UI, as well as using the Lua console to manipulate breakpoints.</p>
<p>Crash Bandicoot 1 has several modes of execution. These modes tell the game what to do, such as which level to load into, or to load back into the map. These modes are passed to the main game loop routine as an argument. Due to this, manually manipulating memory at the right time with the correct value to can be tricky to ensure the desired result.</p>
<p>The game modes are <a href="https://github.com/wurlyfox/crashutils/blob/da21a40a3e8928762eb58b551a54a6e6f8ed73e9/doc/crash/disasm_guide.txt#L131">listed here</a>.</p>
<p>In Crash 1, there is a level that was included in the game but cut from the final level selection due to difficulty, 'Stormy Ascent'. This level can be accessed only by manipulating the game mode value that is passed to the main game routine. There is a gameshark code that points us to the memory location and value that needs to be written in order to set the game mode to the Story Ascent level.</p>
<ul>
<li><code>30011DB0 0022</code> - This is telling us to write the value 0x0022 at memory location <code>0x8001db0</code> 0x0022 is the value of the Stormy Ascent level we want to play.</li>
</ul>
<p>The issue is that GameShark uses a hook to achieve setting this value at the correct time. We will set up a breakpoint to see where the main game routine is.</p>
<p>Setting the breakpoint can be done through the Breakpoint UI or in the Lua console. There is a link to a video at the bottom of the article showing the entire procedure.</p>
<p>Breakpoints can alternatively be set through the Lua console. In PCSX-Redux top menu, click Debug  Show Lua Console</p>
<p>We are going to add a breakpoint to pause execution when memory address 0x8001db0 is read. This will show where the main game loop is located in memory.</p>
<p>In the Lua console, paste the following hit enter.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">bp</span> <span class="o">=</span> <span class="n">PCSX</span><span class="p">.</span><span class="n">addBreakpoint</span><span class="p">(</span><span class="mh">0x80011db0</span><span class="p">,</span> <span class="s1">&#39;Read&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Find main loop&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>You should see where the breakpoint was added in the Lua console, as well as in the Breakpoints UI. Note that we need to assign the result of the function to a variable to avoid garbage collection.</p>
<p>Now open Debug  Show Assembly</p>
<p>Start the emulator with Crash Bandicoot 1 SCUS94900</p>
<p>Right before the BIOS screen ends, the emulator should pause. In the assembly window we can see a yellow arrow pointing to <code>0x80042068</code>. We can see this is a <code>lw</code> instruction that is reading a value from <code>0x8001db0</code>. This is the main game loop reading the game mode value from memory!</p>
<p>Now that we know where the main game loop is located in memory, we can set a conditional breakpoint to properly set the game mode value when the main game routine is executed.</p>
<p>This breakpoint will be triggered when the main game loop at <code>0x80042068</code> is executed, and ensure the value at <code>0x80011db0</code> is set to <code>0x0022</code></p>
<p>In the Lua console, paste the following and hit enter.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">bp</span> <span class="o">=</span> <span class="n">PCSX</span><span class="p">.</span><span class="n">addBreakpoint</span><span class="p">(</span><span class="mh">0x80042068</span><span class="p">,</span> <span class="s1">&#39;Exec&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;Stormy Ascent&#39;</span><span class="p">,</span> <span class="kr">function</span><span class="p">()</span>
  <span class="n">PCSX</span><span class="p">.</span><span class="n">getMemPtr</span><span class="p">()[</span><span class="mh">0x11db0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span>
<span class="kr">end</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<p>We can now disable/remove our Read breakpoint using the Breakpoints UI, and restart the game. Emulation  Hard Reset</p>
<p>If the Emulator status shows Idle, click Emulation  Start</p>
<p>Once the game starts, instead of loading into the main menu, you should load directly into the Stormy Ascent level.</p>
<p>You can see this in action <a href="https://youtu.be/BczviiXUYOY">in this demo video</a>.</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../web_server/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Web server" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Web server
            </div>
          </div>
        </a>
      
      
        
        <a href="../openbios/" class="md-footer__link md-footer__link--next" aria-label="Next: Openbios" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Openbios
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.8aa65030.min.js"></script>
      
    
  </body>
</html>